---
layout: home
title: GIN.IO | Tutorial
---


# Tutorial
This is a simple tutorial showing how to build a Gin application from the grounds up.

This tutorial showcases the use of [Test-Driven Development](http://en.wikipedia.org/wiki/Test-driven_development) techniques to build a simple application that allows to see a list of users, and perform basic operations on them.

> For the purpose of this tutorial we have omitted API authentication. We also assume that you have Gin and MySql properly installed. If not, follow the [install instructions](/docs/install.html) before proceeding.


###### Create application
Let's create an application called `demo`:

```bash
$ gin new demo
Creating app demo...
  created file demo/spec/models/.gitkeep
  created file demo/app/models/.gitkeep
  created file demo/spec/spec_helper.lua
  created file demo/config/settings.lua
  created file demo/spec/controllers/1/pages_controller_spec.lua
  created file demo/db/schemas/.gitkeep
  created file demo/db/mysql.lua
  created file demo/config/nginx.conf
  created file demo/config/errors.lua
  created file demo/lib/.gitkeep
  created file demo/config/application.lua
  created file demo/app/controllers/1/pages_controller.lua
  created file demo/db/migrations/.gitkeep
  created file demo/.gitignore
  created file demo/config/routes.lua
```

Let's now CD in the newly created directory:

```bash
$ cd demo
```

###### Run the default tests
The autogenerated application includes a controller and its tests. Ensure that everything works properly by running `busted`:

```bash
$ busted

●
1 success / 0 failures / 0 pending : 0.052732 seconds.
```

###### Remove the existing controller and controller spec
We will not need the autogenerated application's controller and its test file. Go ahead and delete them:

```bash
$ rm app/controllers/1/pages_controller.lua
$ rm spec/controllers/1/pages_controller_spec.lua
```

### Users index
Let's start by implementing a Users' `index` API call.

###### Create the Users' controller test file
Create the file `./spec/controllers/1/users_controller.lua`, and let's write the first test:

```lua
require 'spec.spec_helper'

describe("UsersController", function()
    describe("#index", function()
        it("shows the list of users", function()
            local response = hit({
                method = 'GET',
                path = "/users"
            })

            assert.are.same(200, response.status)
            assert.are.same({}, response.body)
        end)
    end)
end)
```

As a start, we just want our Users' controller to return a successful response with an empty JSON body. Let's run the tests:

```bash
$ busted spec/controllers/1/users_controller_spec.lua

●
0 successes / 1 failure / 0 pending : 0.025699 seconds.

Failure → ./spec/controllers/1/users_controller_spec.lua @ 5
shows the list of users
./spec/controllers/1/users_controller_spec.lua:11: Expected objects to be the same. Passed in:
(number) 404
Expected:
(number) 200
```

That is to be expected, as we obviously still do not have created the users' controller nor have we specified the routes to handle the request on `/users`.


###### Add the routes
Edit the file `./config/routes.lua`. Let's create a version `1` namespace, and the route to `/users`.

```lua
-- define version
local v1 = Routes.version(1)

-- define routes
v1:GET("/users", { controller = "users", action = "index" })
```

###### Create Users' controller
Create the file `./app/controllers/1/users_controller.lua`, and add the action for the route that we have just defined:

```lua
local UsersController = {}

function UsersController:index()
    return 200, {}
end

return UsersController

```

Our tests will now pass:

```bash
$ busted spec/controllers/1/users_controller_spec.lua

●
1 success / 0 failures / 0 pending : 0.027029 seconds.
```

Congratulations! Now let's modify our controller to return the users in the database.

###### Setup Database
We will be using a MySql database, so let's edit the `./db/db.lua` file with our settings.

```lua
local sqldb = require 'gin.db.sql'

local DbSettings = {

    development = {
        adapter = 'mysql',
        host = "127.0.0.1",
        port = 3306,
        database = "demo_development",
        user = "root",
        password = "",
        pool = 5
    },

    test = {
        adapter = 'mysql',
        host = "127.0.0.1",
        port = 3306,
        database = "demo_test",
        user = "root",
        password = "",
        pool = 5
    },

    production = {
        adapter = 'mysql',
        host = "127.0.0.1",
        port = 3306,
        database = "demo_production",
        user = "root",
        password = "",
        pool = 5
    }
}

MYSQLDB = sqldb.new(DbSettings[Gin.env])
```

We have now defined a `MYSQLDB` connection to our MySql database, that is accessible throughout our application.

###### Create a Users' table

Let's go ahead and generate a new migration:

```bash
$ gin generate migration
Created new migration file
  db/migrations/20131109190242.lua
```

Edit the file `./db/migrations/20131109190242.lua` to create a database in the `up()` method (called when the migration is run), and destroy it in the `down()` method (when the migration is rolled back), like this:

```lua
local SqlMigration = {}

SqlMigration.db = MYSQLDB

function SqlMigration.up()
    SqlMigration.db:execute([[
        CREATE TABLE users (
            id int NOT NULL AUTO_INCREMENT,
            first_name varchar(255) NOT NULL,
            last_name varchar(255),
            PRIMARY KEY (id)
        );
    ]])
end

function SqlMigration.down()
    SqlMigration.db:execute([[
        DROP TABLE users;
    ]])
end

return SqlMigration
```

Let's now apply the migration in the `test` environment:

```bash
$ GIN_ENV=test gin migrate
Migrating up in test environment
Database 'demo_test' does not exist, created.
==> Successfully applied migration: 20131109190242
```

> The migration engine has created the database `demo_test` for us.


###### Create Users model

In order to return users, we first need to create a `Users` model. Go ahead and create the file `./app/models/users.lua`, with this content:

```lua
Users = MYSQLDB:define('users')
```
This defines a model `Users` that corresponds to the database table `users`, for the database connection `MYSQLDB`.

> By convention, models in Gin have plural names.

###### Modify Users' controller test
Let's now modify the Users' controller test to return users. Edit the file `./spec/controllers/1/users_controller.lua` to add some fixture users in our database:

```lua
require 'spec.spec_helper'

local function clean_db()
    MYSQLDB:execute("TRUNCATE TABLE users;")
end

describe("UsersController", function()
    before_each(function()
        clean_db()
    end)

    after_each(function()
        clean_db()
    end)

    describe("#index", function()
        before_each(function()
            roberto = Users.create({first_name = 'roberto', last_name = 'gin'})
            hedy = Users.create({first_name = 'hedy', last_name = 'stripes'})
        end)

        after_each(function()
            roberto = nil
            hedy = nil
        end)

        it("shows the list of users ordered by first name", function()
            local response = hit({
                method = 'GET',
                path = "/users"
            })

            assert.are.same(200, response.status)

            assert.are.same({
                [1] = hedy,
                [2] = roberto
            }, response.body)
        end)
    end)
end)
```

Please note that in Lua, arrays start with index `1`, hence the expectations above.

> Remember to clean up after your tests, this is what the `MYSQLDB:execute("TRUNCATE TABLE users;")` call in `clean_db()` is for. We are calling `clean_db()` before and after all tests, to ensure that the database has a clean start even in the case that previous tests were run improperly or aborted for any reason.

> Also, don't forget to reset any global variables, like `roberto` and `hedy` in the example here above.

Let's run the controller tests:

```bash
$ busted spec/controllers/1/users_controller_spec.lua

●
0 successes / 1 failure / 0 pending : 0.065522 seconds.

Failure → ./spec/controllers/1/users_controller_spec.lua @ 16
shows the list of users ordered by first name
./spec/controllers/1/users_controller_spec.lua:24: Expected objects to be the same. Passed in:
(table): { }
Expected:
(table): {
  [2] = {
    [last_name] = 'gin'
    [first_name] = 'roberto'
    [id] = 1 }
  [1] = {
    [last_name] = 'stripes'
    [first_name] = 'hedy'
    [id] = 2 } }
```

Let's go ahead and edit the controller:

```lua
local UsersController = {}

function UsersController:index()
    local users = Users.all({ order = "first_name" })
    return 200, users
end

return UsersController
```

If we run our tests now:

```bash
$ busted spec/controllers/1/users_controller_spec.lua

●
1 success / 0 failures / 0 pending : 0.06695 seconds.
```

Great! Now what about smoke testing our application in a browser?

###### Prepare the development environment

Ensure migrations are run in the `development` environment:

```bash
$ gin migrate
Migrating up in development environment
Database 'demo_development' does not exist, created.
==> Successfully applied migration: 20131109190242
```

Now let's create some fake users in the `development` database, from the Gin console:

```bash
$ gin console
Loading development environment (Gin v0.0.1)
Lua 5.1.5  Copyright (C) 1994-2012 Lua.org, PUC-Rio
> Users.create({first_name = 'roberto', last_name = 'gin'})
> Users.create({first_name = 'hedy', last_name = 'stripes'})
> pp(Users.all())
{
  {
    first_name = "roberto",
    last_name = "gin",
    id = "1"
  },
  {
    first_name = "hedy",
    last_name = "stripes",
    id = "2"
  }
}
```

As we can see from the `pp` command (aka 'pretty print') issued in the console, our users have successfully been created in the `development` database. Quit the console with `CTRL-C`.

Let's start a server in the `development` environment:

```bash
$ gin start
Gin app in development was succesfully started on port 7200.
```

Open up a browser and point it to the [API Console](/docs/api_console.html) at the address [http://localhost:7200/ginconsole](http://localhost:7200/ginconsole).

Input `http://localhost:7200/users` in the API Console URL bar, and click on the `HIT` button. You should see the response body from your server:

```javascript
[
  {
    "last_name": "stripes",
    "first_name": "hedy",
    "id": 2
  },
  {
    "last_name": "gin",
    "first_name": "roberto",
    "id": 1
  }
]
```

### Users create
Let's now implement the Users' `create` API call.

> For readability concerns, code related to the `index` action described in the previous section is partially omitted.

###### Add controller's test
Edit your controller test to add the tests for the `create` action.


```lua
require 'spec.spec_helper'

local function clean_db()
    MYSQLDB:execute("TRUNCATE TABLE users;")
end

describe("UsersController", function()
    before_each(function()
        clean_db()
    end)

    after_each(function()
        clean_db()
    end)

    [...]

    describe("#create", function()
        it("adds a new user", function()
            local response = hit({
                method = 'POST',
                path = "/users",
                body = { first_name = 'new-user', last_name = 'gin' }
            })

            local new_user = Users.find_by({ first_name = 'new-user' })
            assert.are_not.equals(nil, new_user)

            assert.are.same(201, response.status)
            assert.are.same(new_user, response.body)
        end)
    end)
end)
```

Running the tests returns an error:

```bash
$ busted spec/controllers/1/users_controller_spec.lua

●●
1 success / 1 failure / 0 pending : 0.125744 seconds.

Failure → ./spec/controllers/1/users_controller_spec.lua @ 51
adds a new user
./spec/controllers/1/users_controller_spec.lua:51: Expected objects to not be equal. Passed in:
(nil)
Did not expect:
(nil)
```
The passing test is obviously the one related to the `index` action.

Create the route for the `create` action, by editing the `./config/routes.lua` file:

```lua
-- define version
local v1 = Routes.version(1)

-- define routes
v1:GET("/users", { controller = "users", action = "index" })
v1:POST("/users", { controller = "users", action = "create" })
```

Edit the Users' controller in `./app/controllers/1/users_controller.lua` to add the create action:

```lua
local UsersController = {}

[...]

function UsersController:create()
    local new_user = Users.create(self.request.body)
    return 201, new_user
end

return UsersController
```

Let's run the tests again:

```bash
$ busted spec/controllers/1/users_controller_spec.lua

●●
2 successes / 0 failures / 0 pending : 0.133 seconds.
```

We are now able to allow for user creation.

###### Add params filtering
We're currently not filtering out the params that we are allowing external callers to set in our models. In this example, for instance, we do not want an external caller to be able to set the `id` they want on new users.

Add the test:






###### Validations
