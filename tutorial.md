---
layout: home
title: ZEBRA.IO | Tutorial
---


# Tutorial
This is a simple tutorial showing how to build a Zebra application from the grounds up.

This tutorial showcases the use of [Test-Driven Development](http://en.wikipedia.org/wiki/Test-driven_development) techniques to build a simple application that allows to see a list of users, and perform basic operations on them.

> For the purpose of this tutorial we have omitted API authentication. We also assume that you have Zebra and MySql properly installed. If not, follow the [install instructions](/docs/install.html) before proceeding.


##### Create application
Let's create an application called `demo`:

```bash
$ zebra new demo
Creating app demo...
  created file demo/spec/models/.gitkeep
  created file demo/app/models/.gitkeep
  created file demo/config/settings.lua
  created file demo/spec/spec_helper.lua
  created file demo/spec/controllers/1/pages_controller_spec.lua
  created file demo/db/schemas/.gitkeep
  created file demo/config/nginx.conf
  created file demo/db/db.lua
  created file demo/lib/.gitkeep
  created file demo/config/application.lua
  created file demo/app/controllers/1/pages_controller.lua
  created file demo/db/migrations/.gitkeep
  created file demo/config/initializers/errors.lua
  created file demo/config/routes.lua
```

Let's now CD in the newly created directory:

```bash
$ cd demo
```

##### Run the default tests
The autogenerated application includes a controller and its tests. Ensure that everything works properly by running `busted`:

```bash
$ busted

●
1 success / 0 failures / 0 pending : 0.052732 seconds.
```

##### Remove the existing controller and controller spec
We will not need the autogenerated application's controller and its test file. Go ahead and delete them:

```bash
$ rm app/controllers/1/pages_controller.lua
$ rm spec/controllers/1/pages_controller_spec.lua
```

##### Create the Users' controller test file
Create the file `./spec/controllers/1/users_controller.lua`, and let's write the first test:

```lua
require 'spec.spec_helper'

describe("UsersController", function()
    describe("#index", function()
        it("shows the list of users", function()
            local response = hit({
                method = 'GET',
                path = "/users"
            })

            assert.are.same(200, response.status)
            assert.are.same({}, response.body)
        end)
    end)
end)
```

As a start, we just want our Users' controller to return a successful response with an empty JSON body. Let's run the tests:

```bash
$ busted spec/controllers/1/users_controller_spec.lua

●
0 successes / 1 failure / 0 pending : 0.025699 seconds.

Failure → ./spec/controllers/1/users_controller_spec.lua @ 5
shows the list of users
./spec/controllers/1/users_controller_spec.lua:11: Expected objects to be the same. Passed in:
(number) 404
Expected:
(number) 200
```

That is to be expected, as we obviously still do not have created the users' controller nor have we specified the routes to handle the request on `/users`.


##### Add the routes
Edit the file `./config/routes.lua`. Let's create a version `1` namespace, and the route to `/users`.

```lua
-- define version
local v1 = Routes.version(1)

-- define routes
v1:GET("/users", { controller = "users", action = "index" })
```

If we re-run the tests, we'll get the same 404 response. We still need to create the Users' controller.

##### Create Users' controller
Create the file `./app/controllers/1/users_controller.lua`, and add the action for the route that we have just defined:

```lua
local UsersController = {}

function UsersController:index()
    return 200, {}
end

return UsersController

```

Our tests will now pass:

```bash
$ busted spec/controllers/1/users_controller_spec.lua

●
1 success / 0 failures / 0 pending : 0.027029 seconds.
```

Congratulations! Now let's modify our controller to return the users in the database.

##### Setup Database
We will be using a MySql database, so let's edit the `./db/db.lua` file with our settings.

```lua
local sqldb = require 'zebra.db.sql'

local DbSettings = {

    development = {
        adapter = 'mysql',
        host = "127.0.0.1",
        port = 3306,
        database = "demo_development",
        user = "root",
        password = "",
        pool = 5
    },

    test = {
        adapter = 'mysql',
        host = "127.0.0.1",
        port = 3306,
        database = "demo_test",
        user = "root",
        password = "",
        pool = 5
    },

    production = {
        adapter = 'mysql',
        host = "127.0.0.1",
        port = 3306,
        database = "demo_production",
        user = "root",
        password = "",
        pool = 5
    }
}

MYSQLDB = sqldb.new(DbSettings[Zebra.env])
```

We have now defined a `MYSQLDB` connection to our MySql database, that is accessible throughout our application.

##### Create a Users' table

Let's go ahead and generate a new migration:

```bash
$ zebra generate migration
Created new migration file
  db/migrations/20131109190242.lua
```

Edit the file `./db/migrations/20131109190242.lua` to create a database in the `up()` method (called when the migration is run), and destroy it in the `down()` method (when the migration is rolled back), like this:

```lua
local SqlMigration = {}

SqlMigration.db = MYSQLDB

function SqlMigration.up()
    SqlMigration.db:execute([[
        CREATE TABLE users (
            id int NOT NULL AUTO_INCREMENT,
            first_name varchar(255) NOT NULL,
            last_name varchar(255),
            PRIMARY KEY (id)
        );
    ]])
end

function SqlMigration.down()
    SqlMigration.db:execute([[
        DROP TABLE users;
    ]])
end

return SqlMigration
```

Let's now apply the migration in the `test` environment:

```bash
$ ZEBRA_ENV=test zebra migrate
Migrating up in test environment
Database 'demo_test' does not exist, created.
==> Successfully applied migration: 20131109190242
```

> The migration engine has created the database `demo_test` for us.


##### Create Users model

In order to return users, we first need to create a `Users` model. Go ahead and create the file `./app/models/users.lua`, with this content:

```lua
Users = MYSQLDB:define('users')
```
This defines a model `Users` that corresponds to the database table `users`, for the database connection `MYSQLDB`.

> By convention, models in Zebra have plural names.

##### Modify Users' controller test
Let's now modify the Users' controller test to return users. Edit the file `./spec/controllers/1/users_controller.lua` to add some fixture users in our database:

```lua
require 'spec.spec_helper'

describe("UsersController", function()
    before_each(function()
        Users.create({first_name = 'roberto', last_name = 'zebra'})
        Users.create({first_name = 'hedy', last_name = 'stripes'})
    end)

    after_each(function()
        MYSQLDB:execute("TRUNCATE TABLE users;")
    end)

    describe("#index", function()
        it("shows the list of users ordered by first name", function()
            local response = hit({
                method = 'GET',
                path = "/users"
            })

            assert.are.same(200, response.status)
            assert.are.same({
                {first_name = 'hedy', last_name = 'stripes'},
                {first_name = 'roberto', last_name = 'zebra'}
            }, response.body)
        end)
    end)
end)
```

> Remember to clean up after your tests, this is what the `MYSQLDB:execute("TRUNCATE TABLE users;")` function is for.

```bash
$ busted spec/controllers/1/users_controller_spec.lua

●
0 successes / 1 failure / 0 pending : 0.066798 seconds.

Failure → ./spec/controllers/1/users_controller_spec.lua @ 14
shows the list of users
./spec/controllers/1/users_controller_spec.lua:21: Expected objects to be the same. Passed in:
(table): { }
Expected:
(table): {
  [1] = {
    [first_name] = 'hedy'
    [last_name] = 'stripes' }
  [2] = {
    [first_name] = 'roberto'
    [last_name] = 'zebra' } }
```

Let's go ahead and edit the controller:

```lua

```